app.directive("isFocused",["$timeout",function(a){"use strict";return{restrict:"A",scope:{trigger:"&isFocused"},link:function(b,c){a(b.trigger()?function(){c[0].focus(),"undefined"!=typeof cordova&&cordova.plugins.Keyboard.show()}:function(){"undefined"!=typeof cordova&&cordova.plugins.Keyboard.close()})}}}]),app.directive("imageData",["imageDataCache","base64","webWorkerPool",function(a,b,c){"use strict";return{restrict:"E",scope:{image:"=image"},replace:!0,template:"<img/>",link:function(b,d){b.$watch("image",function(b){b&&b.data&&b.id&&(void 0===a.get(b.id)?c.postMessage(b).then(function(c){var e=c.data;d[0].src=e,a.put(b.id,e)}):d[0].src=a.get(b.id))})}}}]),app.directive("bookEditDetails",["$timeout","$ionicLoading",function(a,b){"use strict";return{restrict:"E",scope:{selectedBook:"=book",editEntry:"=editEntry",newEntry:"=newEntry"},replace:!0,templateUrl:"templates/bookEditDetails.html",link:function(c){b.show(),c.$watch("selectedBook",function(){a(function(){b.hide()},5)})}}}]),app.directive("bookViewDetails",["$timeout","$ionicLoading",function(a,b){"use strict";return{restrict:"E",scope:{selectedBook:"=book"},replace:!0,templateUrl:"templates/bookViewDetails.html",link:function(c){b.show(),c.$watch("selectedBook",function(){a(function(){b.hide()},5)})}}}]),app.factory("base64",function(){"use strict";var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(b){var c,d,e,f,g,h="",i="",j="",k=0;do c=b.charCodeAt(k++),d=b.charCodeAt(k++),i=b.charCodeAt(k++),e=c>>2,f=(3&c)<<4|d>>4,g=(15&d)<<2|i>>6,j=63&i,isNaN(d)?g=j=64:isNaN(i)&&(j=64),h=h+a.charAt(e)+a.charAt(f)+a.charAt(g)+a.charAt(j),c=d=i="",e=f=g=j="";while(k<b.length);return h},decode:function(b){var c,d,e,f,g,h="",i="",j="",k=0,l=/[^A-Za-z0-9\+\/\=]/g;l.exec(b)&&console.log('There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, "+", "/",and "="\nExpect errors in decoding.'),b=b.replace(/[^A-Za-z0-9\+\/\=]/g,"");do e=a.indexOf(b.charAt(k++)),f=a.indexOf(b.charAt(k++)),g=a.indexOf(b.charAt(k++)),j=a.indexOf(b.charAt(k++)),c=e<<2|f>>4,d=(15&f)<<4|g>>2,i=(3&g)<<6|j,h+=String.fromCharCode(c),64!=g&&(h+=String.fromCharCode(d)),64!=j&&(h+=String.fromCharCode(i)),c=d=i="",e=f=g=j="";while(k<b.length);return h}}}),app.factory("imageDataCache",["$cacheFactory",function(a){"use strict";return a("imageData")}]),app.service("inventoryService",["$rootScope","$http","$q","settingsService","base64","$log","APP_CONFIG",function(a,b,c,d,e,f,g){"use strict";function h(){var a;j=d.load(),k=j.activeProfile(),a=k.dbName;var b;return b||(b="undefined"!=typeof cordova?"android"===cordova.platformId?new PouchDB(a,{adapter:"idb",size:50}):new PouchDB(a,{adapter:"websql",location:"default",size:50}):new PouchDB(a,{adapter:"websql"})),b}function i(a){a&&a.createIndex({index:{fields:["value.id"]}}).then(function(a){f.trace("Creating index was successfull: "+JSON.stringify(a))})["catch"](function(a){f.err("Creating index was not successfull: "+JSON.stringify(a))})}var j=d.load(),k=j.activeProfile();return{syncRemote:function(e){var l=c.defer();j=d.load(),k=j.activeProfile();var m=k.couchdb,n=h();if(n){if(k.user&&k.password){var o=encodeURIComponent(k.user)+":"+encodeURIComponent(k.password),p=m.replace("://","://"+o+"@");f.info("Syncing with couchDB started: "+m),b({method:"GET",url:p,timeout:g.timeout}).then(function(){n.sync(p).on("change",function(b){a.$apply(function(){f.info("Updating documents with remote changes..."),f.debug("Updating documents with remote changes with following answer: "+b.toString()),i(n)})}).on("complete",function(b){a.$apply(function(){f.info("Completed sync."),f.debug("Completed sync with following answer: "+b.toString()),l.resolve(b)})}).on("uptodate",function(b){a.$apply(function(){f.info("Already up-to-date."),f.debug("Already up-to-date with following answer: "+b.toString()),l.resolve(b)})}).on("error",function(b){a.$apply(function(){f.error("Error during remote sync with following answer: "+b.toString()),400===b.stats&&f.info("Seems be a remote server error."),l.reject(b)})})["catch"](function(b){a.$apply(function(){f.error("Unkown error during remote sync."+b.toString()),l.resolve(b)})})},function(a){0===a.status?(f.info("Seems to run in offline mode."),e?l.reject(a):l.resolve(a)):(401===a.status&&(f.info("Seems to use invalid login data."),l.reject(a)),f.error("Unkown error during connection check: "+JSON.stringify(a)),l.resolve(a))})}else{var q={};q.status=401,l.reject(q)}return l.promise}},getBook:function(a){var b=c.defer(),d=h();return f.debug("Starting search for book: "+a),d?d.find({selector:{"value.id":{$eq:a}}}).then(function(a){f.debug("Search successfull."),b.resolve({book:a.docs[0]})})["catch"](function(c){f.error("Error searching for book "+a+" :"+c),b.reject(c)}):(f.error("Error during db connection"),b.reject({})),b.promise},read:function(){var b=c.defer(),d={},e=h();return e?(f.debug("Using db-adapter: "+e.adapter),e.allDocs({include_docs:!0,attachments:!0},function(c,e){a.$apply(function(){if(c)f.error("Reading from local db not working: "+JSON.stringify(c)),b.reject(d);else{var a,g=e.rows;if(g&&g.length>0){a=[];for(var h in g){var i=g[h].doc;if(i.value&&i.value.volumeInfo){if(i._attachments){var j=i._attachments["thumbnail_"+i.value.id];j&&(i.image={},i.image.content_type=j.content_type,i.image.data=j.data,i.image.id="thumbnail_"+i.value.id)}i._attachments=null,f.debug("Read following valid book entry: "+i.value.volumeInfo.title),a.push(i)}}}a&&(d.books=a,f.debug("Found "+a.length+" books in inventory.")),b.resolve(d)}})})):b.reject(d),b.promise},searchISBN:function(a,b){if(a&&a.length>0){var c={};c.books={},c.count=0;for(var d in a){var e=a[d].doc;if(e.value&&e.value.volumeInfo){var g=e.value.volumeInfo.industryIdentifiers;g&&(g[0].identifier==b?(c.books[d]=e,c.count++):g.length>1&&g[1].identifier==b&&(c.books[d]=e,c.count++))}}return f.info("Got "+c.count+" results."),c}return f.info("Got no results."),!1},searchID:function(a,b){if(a&&a.length>0){var c={};c.books={},c.count=0;for(var d in a){var e=a[d].doc;e.value&&e.value.id==b&&(c.books[d]=e,c.count++)}return f.info("Got "+c.count+" results."),c}return f.info("Got no results."),!1},search:function(b){var d=c.defer(),e={},g=this,i=h();if(f.debug("Starting search: "+JSON.stringify(b)),b.isbn){var j=""+b.isbn;f.debug("Starting isbn-search: "+j),i.allDocs({include_docs:!0,descending:!0},function(b,c){a.$apply(function(){if(b)f.error("Search error: "+b),d.reject(e);else{var a=g.searchISBN(c.rows,j);a?d.resolve(a):d.reject(e)}})})}else if(b.id){var k=""+b.id;f.debug("Starting id-search: "+k),i.allDocs({include_docs:!0,descending:!0},function(b,c){a.$apply(function(){if(b)f.error("Search error: "+b),d.reject(e);else{var a=g.searchID(c.rows,k);a?d.resolve(a):d.reject(e)}})})}else f.error("Got unknown search query"),d.reject(e);return d.promise},remove:function(b){var d=c.defer(),e=this,g={},j=h();if(f.debug("Starting delete of book: "+b.value.volumeInfo.title),j){var k={};k.id=b.value.id,e.search(k).then(function(b){var c=0,e=[];if(b.books&&(c=b.count),c>0)for(var h in b.books){var k=b.books[h];k._deleted=!0,e.push(k),d.resolve({})}else f.error("Error deleting entry. Book not found"),d.reject(g);j.bulkDocs(e,function(b){a.$apply(function(){b?(f.error("Error deleting entry: "+b),d.reject(b)):(f.info("Delete of entry was successfull."),i(j))})},function(a){f.error("Error deleting entry."),d.reject(a)})})}return d.promise},saveUpdated:function(b,d){var e=c.defer(),g=h();if(f.debug("Starting update for book: "+b.value.volumeInfo.title),g){var i=[];for(var j in d){var k=d[j];k.value=b.value,k.image&&(k._attachments={},k._attachments[k.image.name]={},k._attachments[k.image.name].content_type=b.image.content_type,k._attachments[k.image.name].data=b.image.data),k._attachments&&(k._attachments=k._attachments),i.push(k)}g.bulkDocs(i,function(b,c){a.$apply(function(){b?(f.error("Error updating book:"+b),e.reject(b)):(f.info("Update successfull."),e.resolve(c))})})}else f.error("Error during db connection"),e.reject({});return e.promise},save:function(b){var d=c.defer(),e=this,g={},j=h();if(b.count||(b.count=1),f.debug("Starting save for book: "+b.value.volumeInfo.title),j){var k={};b.value.volumeInfo.industryIdentifiers&&b.value.volumeInfo.industryIdentifiers.length>1?k.isbn=b.value.volumeInfo.industryIdentifiers[1].identifier:k.id=b.value.id,e.search(k).then(function(c){f.info("Found already an db entry");var h=0;if(c.books&&(h=c.count),h===b.count)f.info("Amount not changed"),e.saveUpdated(b,c.books).then(function(){f.info("Update was successfull."),d.resolve(g),i(j)},function(a){f.error("Error updating entry."),d.reject(a)});else{var k=b.count-h;if(k>0){f.info("Adding "+k+" new entries.");for(var l=[],m=1;k>=m;m++){var n={};n.value=b.value,b.image&&(n._attachments={},n._attachments[b.image.name]={},n._attachments[b.image.name].content_type=b.image.content_type,n._attachments[b.image.name].data=b.image.data),l.push(n)}j.bulkDocs(l,function(b){a.$apply(function(){b?(f.error("Error saving new entries: "+b),d.reject(g)):(g.books=l,f.info("Saving successfull."),i(j),d.resolve(g))})})}else{var o=0,p=Math.abs(k);f.info("Removing "+p+" existing entries.");var q=[],r=[];for(var s in c.books){var t=c.books[s];p>o?(t._deleted=!0,t._attachments=null,q.push(t),o++):r.push(t)}j.bulkDocs(q,function(c){a.$apply(function(){c?(f.error("Error during: "+c),d.reject(c)):(f.info("Delete was successfull."),e.saveUpdated(b,r).then(function(a){f.info("Update was successfull."),d.resolve(a),i(j)},function(a){f.error("Error updating entry."),d.reject(a)}))})},function(a){f.error("Error deleting entry."),d.reject(a)})}}},function(c){f.info("Found no existing entries");for(var e=[],g=1;g<=b.count;g++){var h={};h.value=b.value,b.image&&(h._attachments={},h._attachments[b.image.name]={},h._attachments[b.image.name].content_type=b.image.content_type,h._attachments[b.image.name].data=b.image.data),e.push(h)}j.bulkDocs(e,function(b){a.$apply(function(){b?(f.error("Error saving new entries: "+b),d.reject(c)):(c.books=e,f.info("Saving successfull."),d.resolve(c),i(j))})})})}else f.error("Error during db connection"),d.reject(g);return d.promise}}}]),app.service("googleBookService",["$rootScope","$http","$q","$log","settingsService","base64","APP_CONFIG",function(a,b,c,d,e,f,g){"use strict";function h(a){if(d.debug("Converting convertCodeToIsbn: "+a),a&&0===a.indexOf("978")){a=a.substr(3,9);var b=0,c=0,e=0;for(e=0;9>e;e++)c=a.substr(e,1),b+=(10-e)*c;b%=11,b=11-b,10==b&&(b="X"),11==b&&(b="0"),a+=b}return d.debug("Converted convertCodeToIsbn: "+a),a}function i(a,b){var c=[];for(var e in a.items){var f={};if(f.value=a.items[e],b){var g=h(b),i=f.value.volumeInfo.industryIdentifiers;for(var j in i){var k=i[j];k&&k.identifier===g&&(c.push(f),d.info("Found matching result."))}}else c.push(f)}return c}function j(a,b,c){d.debug("Got valid book data.");var e=b.data;if(e){d.debug("Received book RAW data: "+JSON.stringify(e));var f=i(e,c);f.length>0?(b.books=f,a.resolve(b)):(d.info("Received no results."),a.resolve(b))}else d.info("Received no data."),b.books=null,a.resolve(b)}function k(a,b){d.error("Got HTTP error "+b.status+" ("+b.statusText+")"),a.reject(b)}function l(a){var e,f=a.isbn,i=c.defer();if(f){var l=h(f);d.debug("Reading book data for ISBN "+l),e=":isbn="+l}else e=a.keyword;return e?(d.debug("Reading book data with google books url"),b({method:"GET",url:"https://www.googleapis.com/books/v1/volumes/?q="+e+"&projection=full&key="+g.googleApiKey,timeout:g.timeout,headers:{"Access-Control-Allow-Origin":"localhost","Access-Control-Allow-Headers":"Origin, X-Requested-With, Content-Type, Accept"}}).then(function(a){j(i,a,f)},function(a){f?(d.info("Retry with fulltext search once again."),d.debug("Reading book data with google books url"),b({method:"GET",url:"https://www.googleapis.com/books/v1/volumes/?q="+f+"&projection=full&key="+g.googleApiKey,timeout:g.timeout,headers:{"Access-Control-Allow-Origin":"localhost","Access-Control-Allow-Headers":"Origin, X-Requested-With, Content-Type, Accept"}}).then(function(a){j(i,a,f)},function(a){k(i,a)})):k(i,a)})):(d.info("Empty or unkown search criteria."),k(i,{})),i.promise}return{search:l}}]),app.service("settingsService",["$rootScope","$log","$http","localStorageService","APP_CONFIG",function(a,b,c,d,e){"use strict";function f(a){d.remove("flynn_app.settings");var b=a;b.appConfig&&!e.update||(b.appConfig=e),d.add("flynn_app.settings",b)}function g(){b.debug("Loading settings from local storage");var c=d.get("flynn_app.settings");if(c)if(c.profiles&&c.profiles[c.activeProfileID]){var f=c.profiles[c.activeProfileID];f.dbName?c.valid=!0:c.valid=!1,f.remotesync&&(f.user&&f.password?c.valid=!0:c.valid=!1)}else c.valid=!1;else c={},c.valid=!1,c.appConfig=e,c.activeProfileID=0,c.profiles=[],c.profiles.push({});return c.activeProfile=function(){return c.profiles[c.activeProfileID]},a.settings=c,c}function h(a){return"false"===a||"true"===a?JSON.parse(a):a}function i(c,d){var e=c;e.valid=!1,b.debug("Overwriting profile data");for(var g in d)switch(g){case"profiles":for(var i in d.profiles[0])c.profiles||(e.profiles=[]),e.profiles[0][i]=h(decodeURIComponent(d.profiles[0][i]));break;case"appConfig":for(var j in d.appConfig)e.appConfig[j]=h(decodeURIComponent(d.appConfig[j]));break;default:e[g]=h(d[g])}b.debug("Saving overwrite profile data"),f(e),a.$broadcast("settings.updated")}function j(d){b.debug("Handling URL config data");var e=g();d.url?(b.debug("loading profile data from remote URL"),c({method:"GET",url:d.url,timeout:2e3}).success(function(c,d){200===d?i(e,c):(b.error("Could not read remote profile data."),a.$broadcast("settings.invalidHandleUrl"))}).error(function(){b.error("Could not read remote profile data."),a.$broadcast("settings.invalidHandleUrl")})):d.profile?(b.debug("Using passed URL data"),i(e,{profiles:[d]})):(b.debug("Using passed URL data"),i(e,{appConfig:d}))}return{handleURL:j,save:f,load:g,verify:function(){b.debug("Verifying flynn settings");var a=this.load(),c=a.activeProfile();return c.remotesync?c&&c.owner&&c.user&&c.password&&c.couchdb:c&&c.owner}}}]);