app.controller("AppController",["$scope","$rootScope","$log","$state","$window","$ionicLoading","settingsService",function(a,b,c,d,e,f,g){"use strict";f.show(),b.$on("settings.handleURL",function(a,b){g.handleURL(b)}),b.$on("settings.updated",function(){e.location.reload(!0)}),b.$on("settings.invalid",function(){ngFlynnApp.showErrorDialog(b,a,f,c,"Settings invalid",1001,"Settings seems to be incorrect. Please correct or check network settings.")}),b.$on("network.offline",function(){ngFlynnApp.showErrorDialog(b,a,f,c,"No network",1002,"Network connection seems to be not working. Please try again later.")}),b.$on("settings.invalidHandleUrl",function(){ngFlynnApp.showErrorDialog(b,a,f,c,"Settings invalid",1003,"Settings seems to be incorrect. Server did not respond.")}),b.$on("server.timeout",function(){ngFlynnApp.showErrorDialog(b,a,f,c,"Timeout",2001,"No answer from server")}),b.$on("sync.remoteError",function(){ngFlynnApp.showErrorDialog(b,a,f,c,"Server error",1004,"Server doesn't respone with valid answer. Check server backend and/or remote URL.")}),b.$on("server.error",function(){ngFlynnApp.showErrorDialog(b,a,f,c,"Books couldn't be loaded",2002,"The server didn't respond. Please check your network settings.")}),b.$on("login.failed",function(){ngFlynnApp.showErrorDialog(b,a,f,c,"Login error",3001,"Please check your sync user data.")}),b.$on("barcode.error",function(){ngFlynnApp.showErrorDialog(b,a,f,c,"Barcode error",4001,"Barcode reader not working. Did you enable camera access?")}),b.$on("booksearch.invalid",function(){ngFlynnApp.showErrorDialog(b,a,f,c,"Book couldn't be loaded",5001,"The book search wasn't successfull. Server didn't respond.")}),b.$on("booksave.error",function(){ngFlynnApp.showErrorDialog(b,a,f,c,"Book couldn't be saved",5101,"The book save wasn't successfull. Server didn't respond.")}),a.userAgent=navigator.userAgent;var h=g.load();h&&!h.valid?d.go("app.settings"):(f.hide(),d.go("app.books")),b.settings=h}]),app.controller("BookController",["$rootScope","$scope","$ionicLoading","$log","$http","$filter","$q","$state","$resource","$ionicModal","$ionicHistory","settingsService","inventoryService","googleBookService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";function o(){j.fromTemplateUrl("book_modal.html",{scope:b,animation:"slide-in-up"}).then(function(a){b.modal=a}),b.openModal=function(){b.modal.show()},b.closeModal=function(){b.modal.hide()},b.$on("$destroy",function(){b.modal.remove()}),b.barcodeSupported=ngFlynnApp.isMobileDevice()}function p(){c.show(),cordova.plugins.barcodeScanner.scan(function(a){a.cancelled||(d.debug("We got a barcode\nResult: "+a.text+"\nFormat: "+a.format+"\n"),b.searchQuery.isbn=a.text,q()),c.hide()},function(){d.error("Scanning failed."),a.$broadcast("barcode.error"),c.hide()})}function q(){b.books=null,"undefined"!=typeof cordova&&cordova.plugins.Keyboard.close();var a=b.searchQuery;a&&(a.isbn||a.keyword)?(w={},m.read().then(function(b){w=b.books,d.debug("Start searching with criteria:"),s(a)},function(b){d.error("Error during reading inventory for search with critera "+JSON.stringify(a)+":"+JSON.stringify(b))})):"undefined"!=typeof cordova?navigator.notification.alert("Please enter search details.",null,"Info"):alert("Please enter search details.")}function r(a){a.preventDefault();var b={};b.value={},b.value.id=Date.now(),b.value.volumeInfo={},b.value.volumeInfo.industryIdentifiers=[],b.value.volumeInfo.authors=[],b.value.volumeInfo.industryIdentifiers=[],b.value.volumeInfo.industryIdentifiers.push(""),b.value.volumeInfo.industryIdentifiers.push(""),b.value.volumeInfo.authors.push(""),u(b)}function s(e){c.show(),n.search(e).then(function(a){d.info("Got valid service response"),b.books=ngFlynnApp.enrichDbData(a.books),c.hide()},function(){a.$broadcast("booksearch.invalid"),c.hide()})}function t(){b.books=null,b.searchQuery=null,b.selectedBook=null,b.searchQuery={},b.closeModal()}function u(a){c.show();var e=a,f=w,g="";d.debug("Showing details for book: "+a.value.volumeInfo.title);for(var h in a.value.volumeInfo.authors){var i=a.value.volumeInfo.authors;if(i){var j=i.length;g+=i[h],j-1>h&&(g+=", ")}}var k=0;if(f){var l;if(a.value.volumeInfo.industryIdentifiers){var m=a.value.volumeInfo.industryIdentifiers;m[0]&&(l=m[0].identifier)}for(var n in f){var o=f[n],p=o.value.volumeInfo.industryIdentifiers[0].identifier;l&&p==l&&(d.debug("Already found a saved book entry: "+o.value.volumeInfo.title),e=o,k++)}}k>0?(d.debug("Found already entry in couchdb"),e.infoMsg="Book is already added to library. Please update amount."):(d.debug("Found no existing entry in couchdb"),e.infoMsg=null,k=1,e.value.bookshelf=x.lastBookshelf),e.count=k,e.authorInfo=g,e.value.owner=e.value.owner||x.owner,b.selectedBook=e,c.hide(),b.openModal()}function v(b){function e(b){d.info("Successfully added book"),b.noUpdate?navigator.notification.alert("Book already added. Please increase amount."):(g.activeProfile().remotesync&&m.syncRemote().then(function(){d.info("Remote sync completed")},function(){d.error("Remote sync not completed due to errors."),a.$broadcast("settings.invalid"),h.go("app.settings")}),c.hide(),"undefined"!=typeof cordova?navigator.notification.alert("Book successfully added.",t(),"Book"):(alert("Book successfully added."),t()),a.$broadcast("inventory.refresh"),h.go("app.books"))}function f(){c.hide(),a.$broadcast("booksave.error"),d.error("Error during book saving")}c.show(),d.debug("Starting save for book");var g=l.load();if(g.activeProfile().lastBookshelf=b.value.bookshelf,l.save(g),b.authorInfo){var i=b.authorInfo.split(",");if(i.length>0){b.value.volumeInfo.authors=[];for(var j in i){var k=i[j];b.value.volumeInfo.authors.push(k)}}}if(b.isbnInfo){var n=b.isbnInfo.split(",");if(n.length>0){b.value.volumeInfo.industryIdentifiers=[];for(var o in n){var p=n[o];b.value.volumeInfo.industryIdentifiers.push({identifier:p})}}}var q=document.getElementById(b.value.id).getElementsByClassName("img-thumbnail");if(q&&q[0].src){var r=q[0];blobUtil.imgSrcToBlob(r.src).then(function(a){var c=new window.FileReader;c.readAsDataURL(a),c.onloadend=function(){var d={};d.name="thumbnail_"+b.value.id,d.content_type=a.type,d.data=c.result.replace("data:image/jpeg;base64,",""),b.image=d,m.save(b).then(e,f)}})}else m.save(b).then(e,f)}var w,x=l.load().activeProfile();o(),b.searchQuery={},b.scan=p,b.save=v,b.selectBook=u,b.search=q,b.manual=r}]),app.controller("BooksController",["$rootScope","$scope","$state","$filter","$log","$ionicScrollDelegate","$ionicListDelegate","$ionicLoading","$ionicHistory","$http","$ionicModal","$ionicActionSheet","settingsService","inventoryService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";function o(){p(),b.filter={},b.filter.selectedOrder=b.filterModes[0].value,r(!0),a.$on("inventory.refresh",function(){r(!1)})}function p(){k.fromTemplateUrl("filter_modal.html",{scope:b,animation:"slide-in-up"}).then(function(a){b.modal=a}),b.openModal=function(){b.modal.show()},b.closeModal=function(){b.modal.hide()},b.$on("$destroy",function(){b.modal.remove()}),b.filterModes=[{label:"sort by title",value:"value.volumeInfo.title"},{label:"sort by author",value:"authorInfo"}]}function q(){h.show({template:"<ion-spinner></ion-spinner> <br> Syncing books ..."}),n.syncRemote().then(function(){h.hide()},function(b){h.hide(),401===b.status?a.$broadcast("login.failed"):a.$broadcast("settings.invalid")})}function r(c){h.show(),b.searchQuery={},n.read().then(function(a){a.books&&a.books.length>0?(z=ngFlynnApp.enrichDbData(a.books),b.books=ngFlynnApp.enrichDbData(a.books),A.activeProfile().remotesync&&!c&&q(),f.scrollTop(),b.$broadcast("scroll.refreshComplete")):b.msg="No books found.",h.hide()},function(){a.$broadcast("server.error"),b.searchQuery={},h.hide()})}function s(){b.books=d("bookFilter")(z,b.searchQuery.fullTextSearch)}function t(){b.searchQuery={},b.books=z}function u(d){n.remove(d).then(function(){b.books.splice(b.books.indexOf(d),1),a.$broadcast("inventory.refresh"),c.go("app.books",{},{reload:!0})},function(){h.hide(),a.$broadcast("server.error")})}function v(){b.openModal()}function w(){b.closeModal()}function x(a){e.debug("Showing details for book: "+a.value.volumeInfo.title),c.go("app.book_show",{book:a})}function y(a){b.book=a,l.show({buttons:[{text:"<b>Edit</b>"}],destructiveText:"Delete",titleText:"Modify book entry",cancelText:"Cancel",cancel:function(){},buttonClicked:function(){return c.go("app.book_edit",{bookId:a.value.id}),!0},destructiveButtonClicked:function(){return"undefined"!=typeof cordova?navigator.notification.confirm("Really remove book "+b.book.value.volumeInfo.title+" ?",function(a){1===a&&u(b.book)}):confirm("Really remove book "+b.book.value.volumeInfo.title+" ?")&&u(b.book),g.closeOptionButtons(),!0}})}var z,A=m.load();o(),b.load=r,b.showFilterModal=v,b.applyFilter=w,b.showBookDetails=x,b.showActionMenu=y,b.resetSearch=t,b.doSearch=s}]),app.controller("BookDetailsController",["$scope","$state","$stateParams","$log",function(a,b,c,d){"use strict";function e(a){d.debug("Editing details for book: "+a.value.volumeInfo.title),b.go("app.book_edit",{book:a})}function f(a){d.debug("Uploading attachements for book: "+a.value.volumeInfo.title),b.go("app.book_upload",{book:a})}function g(){a.selectedBook=c.book}g(),a.edit=e,a.upload=f}]),app.controller("BookEditController",["$rootScope","$scope","$state","$stateParams","$ionicLoading","$location","$log","settingsService","inventoryService",function(a,b,c,d,e,f,g,h,i){"use strict";function j(){function d(b){g.info("Successfully added book"),b.noUpdate?navigator.notification.alert("Book already added. Please increase amount."):(k.activeProfile().remotesync&&i.syncRemote().then(function(){},function(){a.$broadcast("settings.invalid"),c.go("app.settings")}),e.hide(),navigator.notification.alert("Book successfully updated.",c.go("app.books"),"Book"))}function f(){a.$broadcast("booksave.error"),g.debug("Error during book saving."),e.hide()}var j=b.selectedBook,k=h.load();if(e.show(),g.debug("Starting save for book."),j.authorInfo){var l=j.authorInfo.split(",");if(l.length>0){j.value.volumeInfo.authors=[];for(var m in l){var n=l[m];j.value.volumeInfo.authors.push(n)}}}if(j.isbnInfo){var o=j.isbnInfo.split(",");if(o.length>0){j.value.volumeInfo.industryIdentifiers=[];for(var p in o){var q=o[p];j.value.volumeInfo.industryIdentifiers.push({identifier:q})}}}var r=document.getElementById(j.value.id).getElementsByClassName("img-thumbnail");r&&r[0].src&&!j.image?blobUtil.imgSrcToBlob(r[0].src).then(function(a){var b=new window.FileReader;b.readAsDataURL(a),b.onloadend=function(){var c={};c.name="thumbnail_"+j.value.id,c.content_type=a.type,c.data=b.result.replace("data:image/jpeg;base64,",""),j.image=c,i.save(j).then(d,f)}}):i.save(j).then(d,f)}function k(){b.selectedBook=d.book}k(),b.save=j}]),app.controller("BookUploadController",["$rootScope","$scope","$state","$stateParams","$ionicLoading","$location","$log","settingsService","inventoryService","Upload",function(a,b,c,d,e,f,g,h,i,j){"use strict";function k(){function d(b){g.info("Successfully added book"),b.noUpdate?navigator.notification.alert("Book already added. Please increase amount."):(k.activeProfile().remotesync&&i.syncRemote().then(function(){},function(){a.$broadcast("settings.invalid"),c.go("app.settings")}),e.hide(),navigator.notification.alert("Book successfully updated.",c.go("app.books"),"Book"))}function f(){a.$broadcast("booksave.error"),g.debug("Error during book saving."),e.hide()}var j=b.selectedBook,k=h.load();if(e.show(),g.debug("Starting save for book."),j.authorInfo){var l=j.authorInfo.split(",");if(l.length>0){j.value.volumeInfo.authors=[];for(var m in l){var n=l[m];j.value.volumeInfo.authors.push(n)}}}if(j.isbnInfo){var o=j.isbnInfo.split(",");if(o.length>0){j.value.volumeInfo.industryIdentifiers=[];for(var p in o){var q=o[p];j.value.volumeInfo.industryIdentifiers.push({identifier:q})}}}var r=document.getElementById(j.value.id).getElementsByClassName("img-thumbnail");r&&r[0].src&&!j.image?blobUtil.imgSrcToBlob(r[0].src).then(function(a){var b=new window.FileReader;b.readAsDataURL(a),b.onloadend=function(){var c={};c.name="thumbnail_"+j.value.id,c.content_type=a.type,c.data=b.result.replace("data:image/jpeg;base64,",""),j.image=c,i.save(j).then(d,f)}}):i.save(j).then(d,f)}function l(){b.selectedBook=d.book}l(),b.save=k}]),app.controller("SettingsController",["$rootScope","$log","$scope","$ionicLoading","$state","logService","settingsService","inventoryService",function(a,b,c,d,e,f,g,h){"use strict";function i(){b.debug("Loading settings from local storage");var a=g.load();c.flynn={},c.flynn.activeProfile={},c.flynn.activeProfile.name=a.activeProfile().name||"default",c.flynn.activeProfile.owner=a.activeProfile().owner,c.flynn.activeProfile.dbName=a.activeProfile().dbName||"flynnDB_"+c.flynn.activeProfile.name,c.flynn.activeProfile.remotesync=a.activeProfile().remotesync||!1,c.flynn.activeProfile.couchdb=a.activeProfile().couchdb,c.flynn.activeProfile.user=a.activeProfile().user,c.flynn.activeProfile.password=a.activeProfile().password,c.logging={},c.logging.logLevels=[{name:"Errors only",logLevel:"ERROR"},{name:"Info",logLevel:"INFO"},{name:"Debug info",logLevel:"DEBUG"},{name:"Trace messages",logLevel:"TRACE"}]}function j(){d.show(),f.clearLogData().then(function(){k()},function(){d.hide()})}function k(){d.show({template:'<i class="icon ion - looping loading-icon"></i>&nbsp;&nbsp;Loading log data ...'}),f.readLogData().then(function(a){c.logs=a,d.hide()},function(){b.error("No log entries found"),d.hide()})}function l(){var a="";for(var b in c.logs){var d=c.logs[b];a+="<p>"+d.timestamp+" - "+d.level+":"+d.details+"</p>"}cordova.plugins.email.open({subject:"flynn: Log details",body:"<br><br><h3>Log-Entries:</h3><br>"+a,isHtml:!0})}function m(){h.read().then(function(){b.debug("Got valid server response. Settings seems to be valid."),e.go("app.books")},function(){g.valid=!1,a.$broadcast("settingsService.invalid")})}function n(a){b.debug("Saving settings to local storage");var d=c.flynn.activeProfile,e={},f=[];f.push(d),e.activeProfileID=0,e.profiles=f,g.save(e),a&&(c.flynn.activeProfile.remotesync?o():m())}function o(){d.show({template:'<i class="icon ion - looping loading-icon"></i>&nbsp;&nbsp;Syncing books ...'}),h.syncRemote(!0).then(function(){d.hide(),m()},function(b){switch(d.hide(),b.status){case 0:a.$broadcast("network.offline");break;case 400:a.$broadcast("sync.remoteError");break;case 401:a.$broadcast("login.failed");break;default:a.$broadcast("settings.invalid")}})}i(),k(),c.load=i,c.save=function(){n(!0)},c.sync=function(){n(!1),o()},c.showLogs=k,c.clearLogs=j,c.emailLogs=l,c.filterLogs=function(){if(c.logging.selectedLogLevel){d.show();var a=c.logging.selectedLogLevel.logLevel;f.readLogData(a).then(function(a){c.logs=a,d.hide()},function(){d.hide()})}else k()}}]),app.controller("AboutController",["$scope","$rootScope","APP_INFO",function(a,b,c){"use strict";var d=function(){var b=[];angular.forEach(c,function(a,b){if("release_notes"===b){var c={};c.label=a.label,c.hidden=a.hidden,c.value=a.value;var d='<ul class="list-group">'+c.value.replace(/[0-9a-f]{7}/g,'<li class="list-group-item">')+"</ul>";c.value=d,this.push(c)}else this.push(a)},b),a.info=b};d()}]),app.controller("DevController",function(){"use strict"});